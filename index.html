<!-- 

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->

<!-- 
    This code was written by a person with very little Web/JS knowledge, don't judge. 
    Send bug reports to: mathgeneratorfeedback@qrck.org
-->
<html>
    <head>
        <title>Math's 6 class</title>
        <link rel="stylesheet" type="text/css" href="main.css">
    </head>
    <body>

        <div id="contentRoot"></div>

        <div id="inputForm">
            <input type="checkbox" id="debug1" checked="true">Debug!</input>

            <h3>Number of problems:</h3> 
            <input type="number" id="num_problems" value="60"/>
            <br/><br/>
            <input type="button" id="generate" onclick="generate()" value="Generate!"/>
            <p><b>Use the content of this page at your own risk, not warranty given</b></p>
            <br><br>
            <p>License information:</p>
            <p>Generated content: <a href="https://wiki.creativecommons.org/wiki/public_domain">Public domain</a></p>
            <p>Source code: <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU GPLv3 license</a></p>
        </div>

        <script language="JavaScript" src="util.js"></script>
        <script language="JavaScript" src="geometry.js"></script>
        <script language="JavaScript" src="data.js"></script>
        <script language="JavaScript" src="problems.js"></script>

        <script language="JavaScript">                    
            function hideForm()
            {
                let form = document.getElementById('inputForm')
                while (form.hasChildNodes())
                {
                    form.removeChild(form.childNodes[0])
                }
            }

            function newChild(parent, type, attr)
            {
                let newElement = document.createElement(type)
                parent.appendChild(newElement)
                if (attr) 
                {
                    for (let name of Object.keys(attr))
                    {
                        if (name == 'innerHTML')
                        {
                            newElement.innerHTML = attr[name]
                        }
                        else
                        {
                            newElement.setAttribute(name, attr[name])
                        }
                    }
                }
                return newElement
            }

            function generateMainLayout()
            {
                let root = document.getElementById("contentRoot")

                // main table with the problems 
                let problems = newChild(root, "table", {width: "100%"})
                let tr = newChild(problems, "tr", {valign: 'top'})
                let leftTd = newChild(tr, "td", {width: "50%"})
                let rightTd = newChild(tr, "td", {width: "50%"})
                let leftSubTable = newChild(leftTd, "table")
                let rightSubTable = newChild(rightTd, "table")

                let pageBreak = newChild(root, "div", {style: "break-after:page"})

                let answersLabel = newChild(root, 'div', {innerHTML: '<h2>Answers<h2>'})

                let answers = newChild(root, "table",  {width: "100%"})
                let ansTr = newChild(answers, "tr", {valign: 'top'})
                let ansLeftTd = newChild(ansTr, "td", {width: "50%"})
                let ansRightTd = newChild(ansTr, "td", {width: "50%"})
                let ansLeftSubTable = newChild(ansLeftTd, "table")
                let ansRightSubTable = newChild(ansRightTd, "table")

                return {
                    problems: {
                        left: leftSubTable, 
                        right: rightSubTable 
                    }, 
                    answers: {
                        left: ansLeftSubTable, 
                        right: ansRightSubTable 
                    },
                }
            }

            function generateEntry(table, n, isProblemEntry)
            {
                let tr = newChild(table, "tr", {valign: 'top'})
                table.appendChild(tr)

                let numMark = isProblemEntry ? ("<b>" + n + ")</b><p/>&nbsp;") : ("<b>" + n + ")</b>")
                let tdClass = (isProblemEntry ? 'problem' : 'answer')

                let td1 = newChild(tr, "td", {innerHTML: numMark})
                let td2 = newChild(tr, "td", {class: tdClass})

                return td2
            }                    
            
            function generate()
            {
                let num_problems = parseInt(document.getElementById('num_problems').value)
                let debug = document.getElementById('debug')
                if (debug)
                    debug = debug.checked

                hideForm()

                let cont = generateMainLayout()

                // let letftColumn = document.getElementById("viewRoot1")
                // let rightColumn = document.getElementById("viewRoot2")

                // let letftAnsColumn = document.getElementById("ansRoot1")
                // let rightAnsColumn = document.getElementById("ansRoot2")

                let generators = getGenerators()
                let maxCounts = getMaxProbEntries()
                let catNames = Object.keys(generators)

                if (!debug)
                {
                    for (let idx = 0; idx < num_problems; ++ idx)
                    {
                        let even = idx % 2 == 0

                        let problemsRow = generateEntry(even ? cont.problems.left : cont.problems.right, idx + 1, true)
                        let answersRow = generateEntry(even ? cont.answers.left : cont.answers.right, idx + 1, false)

                        for (;;)
                        {
                            let cat = generators[catNames[randInt(catNames.length)]]                        
                            let prob = cat[randInt(cat.length)]
                            let name = prob.name
                            if (Object.keys(maxCounts).includes(name))
                            {
                                if (maxCounts[name] <= 0)
                                    continue
                                maxCounts[name] -= 1
                            }
                            prob.fun(problemsRow, answersRow)
                            break
                        }
                        
                    }
                }
                else
                {
                    let bigidx = 1
                    for (let catName of catNames)
                    {
                        let cat = generators[catName]

                        for (let idx = 0; idx < cat.length; ++ idx)
                        {
                            let nameRowLeft = generateEntry(cont.problems.left, bigidx, false)
                            let nameRowRight = generateEntry(cont.problems.right, bigidx+1, false)
                            nameRowLeft.innerHTML = '<b>L ' + cat[idx].name + '</b>'
                            nameRowRight.innerHTML = '<b>R ' + cat[idx].name + '</b>'

                            let problemsRowLeft = generateEntry(cont.problems.left, bigidx, true)
                            let answersRowLeft = generateEntry(cont.answers.left, bigidx, false)
                            let problemsRowRight = generateEntry(cont.problems.right, bigidx+1, true)
                            let answersRowRight = generateEntry(cont.answers.right, bigidx+1, false)
                            
                            cat[idx].fun(problemsRowLeft, answersRowLeft)
                            cat[idx].fun(problemsRowRight, answersRowRight)

                            bigidx += 2
                        }
                    }

                }
            }

            if (document.getElementById('debug'))
                generate()
        </script>
    </body>
</html>